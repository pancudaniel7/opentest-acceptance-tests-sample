description: Verify if the pulsar broker sending and receiving avro messages works
actors:
  - actor: PULSAR
    segments:
      - segment: 1
        actions:
          - description: Create the pulsar producer
            action: com.raiffeisen.opentest.pulsarium.CreateProducers
            args:
              producers:
                - producerName: producer1
                  topicName: customer
                  schemaType: AVRO
                  schema: $data("schema/customer-schema")
          - description: Sent avro messages to the broker
            action: com.raiffeisen.opentest.pulsarium.SendAvroFlatMessages
            args:
              producerName: producer1
              schemaName: Customer
              messages: $data("csv/customers.csv")
          - description: Create pulsar consumer
            action: com.raiffeisen.opentest.pulsarium.CreateConsumers
            args:
              consumers:
                - topicNames: [ 'customer' ]
                  subscriptionName: consumer-subscription
                  consumerName: consumer1
                  schemaType: AVRO
                  schema: $data("schema/customer-schema")
          - description: Consume messages from broker
            action: com.raiffeisen.opentest.pulsarium.ConsumeAvroMessages
            args:
              consumerName: consumer1
              consumingStopLength: 2
              $localData:
                consumedMessages: $output.consumedMessages
          - script: |
                var messages = $localData.consumedMessages
                $log("messages:")
                for(var i=0; i<messages.length; i++){
                  $log("record:" + i)
                  $log("customerNumber: " + messages[i]["customerNumber"])
                  $log("gender: " + messages[i]["gender"])
                  $log("given: " + messages[i]["given"])
                  $log("family: " + messages[i]["family"])
                  $log("birthDate: " + messages[i]["birthDate"])
                  $log("nationality: " + messages[i]["nationality"])
                  $log("country: " + messages[i]["country"])
                  $log("city: " + messages[i]["city"])
                }
                